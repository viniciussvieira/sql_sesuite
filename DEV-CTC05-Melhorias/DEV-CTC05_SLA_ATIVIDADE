SELECT	IDPROCESS AS "ID Processo",
			NMPROCESS AS "Nome Processo",
			COALESCE(TABLE0__NMPRODUTO_0,TABLE0__NMPRODUTON_0) AS "Nome do Produto",
			-- NMDEADLINE AS SLA,
			DTSTART AS "Data de Início",
			IDSITUATION AS "Situação do Processo",
			NMUSERSTART AS SOLICITANTE,
			IDREVISIONSTATUS,
			NMREVISIONSTATUS,
			-- DTDEADLINEFIELD AS "Data de Deadline",
			IDREVISION Revisão,
			DTFINISH AS "Data de Finalização",
			-- DTSLAFINISH AS "Data de SLA Finalizado",
			TABLE0__FGALTNORMA_7 AS "Afeta atendimento da norma",
			TABLE0__FGALTCIRC_7 AS "Alteração de Circuito Impresso",
			TABLE0__FGESQELETR_7 AS "Alteração de Esquema Elétrico",
			TABLE0__FGAFETAAOI_7 AS "Afeta AOI",
			TABLE0__FGALTETI_7 AS "Alteração de Etiqueta",
			TABLE0__FGALTSTEN_7 AS "Alteração Estêncil",
			TABLE0__FGALTISER_7 AS "Alteração de Inserção",
			TABLE0__FGALTTRI_7 AS "Alteração no TRI",
			TABLE0__FGALTMEC_7 AS "Alteração Mecânica",
			TABLE0__FGALTPCM_7 "Alterar Sucateamento",
			TABLE0__FGCATEGORIA_3 AS Categoria,
			TABLE0__DTPREVIMPL_6 AS "Data Prevista de Implantação",
			TABLE0__DTIMPLANT_6 AS "Data de Implantação",
			TABLE0__DTDATA_6 AS "Data da Solicitação",
			TABLE0__HRHORA_5 AS "Hora da Solicitação",
			TABLE0__IDETIQUETA_1 AS "ID Etiqueta",
			TABLE0__IDGETORPROJETO_1 AS "ID Gestor de Projeto",
			TABLE0__IDMEC_1 AS "ID Mecânica",
			TABLE0__IDPED_1 AS "ID PeD",
			TABLE0__IDSOLICITACAO_0 AS "ID da Solicitação",
			TABLE0__NMMOTIVOALT_2 AS "Motivo da Alteração",
			TABLE0__NMMOTIVO_2 AS Motivo,
			TABLE0__CDPRODUTO_0 AS "Código do Produto",       
			TABLE0__NMGESTORPROJETO_1 AS "Nome Gestor de Projeto",
			TABLE0__NMPED_1 AS "Nome PeD",
			TABLE0__NOTIFICADOSSEG_2 AS "Notificados Segmento",
			TABLE0__NRPO_3 AS PO,
			TABLE0__FGTIPOPROD_3 as "Tipo de Produto",
			TABLE0__FGTIPOSOLICITAC_3 AS "Tipo de Solicitação",
			TABLE0__NMTITULO_1 AS Título,
			TABLE0_REF0_NMIMPLEMENTACAO_1 AS Implementação,
			TABLE0_REF1_NMLOCAL_0 AS "Local de Fabricação",
			TABLE0_REF2_SEGMENTO_1 AS SEGMENTO,
			TABLE0_REF3_TIPOFABRICACAO_0 AS "Tipo de Fabricação",
			TABLE0_REF4_UNIDADE_1 AS UNIDADE,
			ATIVIDADE,
			CODIGO_PRODUTO_ACABADO AS "Código Do Produto Acabado",
			DESCRICAO_PRODUTO_ACABADO AS "Descrição Do Produto Acabado",          
			CODIGO_PRODUTO_SEMI_ACABADO AS "Código Do Produto Semi Acabado",
			DESCRICAO_PRODUTO_SEMI_ACABADO AS "Descrição Do Produto Semi Acabado",     
			CODIGO_COMPONENTE AS "Código Componente",
			DESCRICAO_COMPONENTE AS "Descrição do Componente",                                 
			CODIGO_ESTRUTURA AS "Código Da Estrutura",
			DESCRICAO_ESTRUTURA AS "Descrição Da Estrutura",
			PRAZO_ATV,
			SITUACAO_ATIVIDADE,
			DATA_EXECUCAO_ATIVIDADE,
			RESPONSAVEL_ATIVIDADE,
			-- DIAS_ATRASO,
			ESTADOATV
	  FROM	(		
		SELECT	1 										AS QTD,
				--DADOS DO PROCESSO/WORKFLOW
				WFP.IDPROCESS,
				WFP.NMPROCESS,
				WFP.NMPROCESSMODEL,
				WFP.IDREVISION,
				ADU.NMUSER 								AS NMUSERSTART,																
				CASE WFP.FGSTATUS 
					WHEN 1 THEN '#{103131}' -- ANDAMENTO
					WHEN 2 THEN '#{107788}' -- SUSPENSO
					WHEN 3 THEN '#{104230}' -- CANCELADO
					WHEN 4 THEN '#{100667}' -- ENCERRADO
					WHEN 5 THEN '#{200712}' -- BLOQUEADO PARA EDIÇÃO
				END AS IDSITUATION,
				GNRS.IDREVISIONSTATUS,
				GNRS.NMREVISIONSTATUS,
				TO_TIMESTAMP(TO_CHAR(WFP.DTSTART,  'YYYY-MM-DD') || ' ' || WFP.TMSTART, 'YYYY-MM-DD HH24:MI:SS') 	AS DTSTART,
				TO_TIMESTAMP(TO_CHAR(WFP.DTFINISH, 'YYYY-MM-DD') || ' ' || WFP.TMFINISH,'YYYY-MM-DD HH24:MI:SS') 	AS DTFINISH,	
				
				--DADOS DA ATIVIDADE
				WFACTIVITY.IDSTRUCT 																				AS ATIVIDADE,							
				CASE 
					WHEN WFACTIVITY.FGSTATUS=1 THEN '#{114667}' --A iniciar
					WHEN WFACTIVITY.FGSTATUS=2 THEN '#{114666}' --Habilitado
					WHEN WFACTIVITY.FGSTATUS=3 THEN '#{107507}' --Executado
					WHEN WFACTIVITY.FGSTATUS=4 THEN '#{108240}' --Suspenso
					WHEN WFACTIVITY.FGSTATUS=5 THEN '#{102338}' --Cancelado
					WHEN WFACTIVITY.FGSTATUS=6 THEN '#{206049}' --Recusado
					WHEN WFACTIVITY.FGSTATUS=7 THEN '#{214511}' -- Aprovação de retorno
				END 																								AS SITUACAO_ATIVIDADE,
				WFACTIVITY.DTEXECUTION + (WFACTIVITY.NRTIMEEXECUTION * interval '1 minute') 						AS DATA_EXECUCAO_ATIVIDADE,
				COALESCE(WFACTIVITY.NMUSER,WFACTIVITY.NMROLE) ::VARCHAR(255) 										AS RESPONSAVEL_ATIVIDADE,
				
				--DADOS DO FORMULÁRIO
				TABLE0.FGALTNORMA 			AS TABLE0__FGALTNORMA_7,
				TABLE0.FGALTCIRC 			AS TABLE0__FGALTCIRC_7,
				TABLE0.FGESQELETR 			AS TABLE0__FGESQELETR_7,
				TABLE0.FGAFETAAOI 			AS TABLE0__FGAFETAAOI_7,
				TABLE0.FGALTETI 			AS TABLE0__FGALTETI_7,
				TABLE0.FGALTSTEN 			AS TABLE0__FGALTSTEN_7,
				TABLE0.FGALTISER 			AS TABLE0__FGALTISER_7,
				TABLE0.FGALTTRI 			AS TABLE0__FGALTTRI_7,
				TABLE0.FGALTMEC 			AS TABLE0__FGALTMEC_7,
				TABLE0.FGCATEGORIA 			AS TABLE0__FGCATEGORIA_3,
				TABLE0.DTPREVIMPL 			AS TABLE0__DTPREVIMPL_6,
				TABLE0.DTIMPLANT  			AS TABLE0__DTIMPLANT_6,
				TABLE0.DTDATA 				AS TABLE0__DTDATA_6,
				CAST(TABLE0.HRHORA AS NUMERIC(19)) * 1000 AS TABLE0__HRHORA_5,
				TABLE0.IDETIQUETA 			AS TABLE0__IDETIQUETA_1,
				TABLE0.IDGETORPROJETO 		AS TABLE0__IDGETORPROJETO_1,
				TABLE0.IDMEC 				AS TABLE0__IDMEC_1,
				TABLE0.IDPED 				AS TABLE0__IDPED_1,
				TABLE0.IDSOLICITACAO 		AS TABLE0__IDSOLICITACAO_0,
				TABLE0.NMMOTIVOALT 			AS TABLE0__NMMOTIVOALT_2,
				TABLE0.NMMOTIVO 			AS TABLE0__NMMOTIVO_2,
				TABLE0.NMPRODUTON 			AS TABLE0__NMPRODUTON_0,
				TABLE0.NMPRODUTO 			AS TABLE0__NMPRODUTO_0,
				TABLE0.CDPRODUTO 			AS TABLE0__CDPRODUTO_0,
				TABLE0.NMGESTORPROJETO 		AS TABLE0__NMGESTORPROJETO_1,
				TABLE0.NMPED 				AS TABLE0__NMPED_1,
				TABLE0.NOTIFICADOSSEG 		AS TABLE0__NOTIFICADOSSEG_2,
				TABLE0.NRPO ::varchar(255)	AS TABLE0__NRPO_3,
				TABLE0.NMSEGMENTO 			AS TABLE0__NMSEGMENTO_0,
				TABLE0.NMSITUACAO 			AS TABLE0__NMSITUACAO_1,
				TABLE0.FGALTPCM 			AS TABLE0__FGALTPCM_7,
				TABLE0.FGTIPOPROD 			AS TABLE0__FGTIPOPROD_3,
				TABLE0.FGTIPOSOLICITAC 		AS TABLE0__FGTIPOSOLICITAC_3,
				TABLE0.NMTITULO 			AS TABLE0__NMTITULO_1,
				REF0.NMIMPLEMENTACAO 		AS TABLE0_REF0_NMIMPLEMENTACAO_1,
				REF1.NMLOCAL 				AS TABLE0_REF1_NMLOCAL_0,
				REF2.CDCCPRODLANC 			AS TABLE0_REF2_CDCCPRODLANC_1,
				REF2.DSCCPRODLANC 			AS TABLE0_REF2_DSCCPRODLANC_1,
				REF2.NMDIRETORUNID			AS TABLE0_REF2_NMDIRETORUNID_1,
				REF2.NMGERENTESEG 			AS TABLE0_REF2_NMGERENTESEG_1,
				REF2.IDDIRETORUNID 			AS TABLE0_REF2_IDDIRETORUNID_1,
				REF2.IDSUPERVISORCAT 		AS TABLE0_REF2_IDSUPERVISORCAT_1,
				REF2.IDGERENTESEG 			AS TABLE0_REF2_IDGERENTESEG_1,
				REF2.NMSEGMENTO 			AS TABLE0_REF2_NMSEGMENTO_1,
				REF2.SEGMENTO 				AS TABLE0_REF2_SEGMENTO_1,
				REF2.NMSUPERVISORCAT 		AS TABLE0_REF2_NMSUPERVISORCAT_1,
				REF3.TIPOFABRICACAO 		AS TABLE0_REF3_TIPOFABRICACAO_0,
				REF4.NMDIRETORUNID 			AS TABLE0_REF4_NMDIRETORUNID_1,
				REF4.DIRETOR 				AS TABLE0_REF4_DIRETOR_1,
				REF4.IDDIRETORUNID 			AS TABLE0_REF4_IDDIRETORUNID_1,
				REF4.UNIDADE 				AS TABLE0_REF4_UNIDADE_1,
				REF5.CDPRODUTO 				AS CODIGO_PRODUTO_ACABADO,
				REF5.DSPRODUTO 				AS DESCRICAO_PRODUTO_ACABADO, 
				REF6.CDPRODUTO 				AS CODIGO_PRODUTO_SEMI_ACABADO,
				REF6.DSPRODUTO 				AS DESCRICAO_PRODUTO_SEMI_ACABADO,     
				REF7.CDPRODUTO 				AS CODIGO_COMPONENTE,
				REF7.DSPRODUTO 				AS DESCRICAO_COMPONENTE,
				REF8.CDPRODUTO 				AS CODIGO_ESTRUTURA,
				REF8.DSPRODUTO 				AS DESCRICAO_ESTRUTURA,

                --CALCULOS SLA ATIVIDADE
				----------------------------------
				CASE WHEN WFACTIVITY.FGCONCLUDEDSTATUS IS NOT NULL THEN 
					CASE WHEN WFACTIVITY.FGCONCLUDEDSTATUS = 1 
						THEN 'Em dia' 
					WHEN WFACTIVITY.FGCONCLUDEDSTATUS = 2 
						THEN 'Em atraso' 
					END 
				ELSE 
					CASE WHEN WFACTIVITY.FGTYPE = 1 THEN 
						--Só é necessário realizar as verificações abaixo com subselects, etc. se houver subprocesso. Como o processo CTC05 não possui subprocessos, o código abaixo não é necessário.
						--CASE WHEN ((SELECT WFPD.DTESTIMATEDFINISH FROM WFSTRUCT STRUCT INNER JOIN WFSUBPROCESS SUB ON STRUCT.IDOBJECT = SUB.IDOBJECT INNER JOIN WFPROCESS WFPD ON WFPD.IDOBJECT = SUB.IDSUBPROCESS WHERE STRUCT.IDOBJECT = WFACTIVITY.IDOBJECT) > CAST((CURRENT_DATE + INTERVAL '1 day') AS TIMESTAMP)
						--OR (		SELECT WFPD.DTESTIMATEDFINISH FROM WFSTRUCT STRUCT INNER JOIN WFSUBPROCESS SUB ON STRUCT.IDOBJECT = SUB.IDOBJECT INNER JOIN WFPROCESS WFPD ON WFPD.IDOBJECT = SUB.IDSUBPROCESS WHERE STRUCT.IDOBJECT = WFACTIVITY.IDOBJECT) IS NULL) 
						--	THEN 'Em dia' 
						--WHEN (( SELECT WFPD.DTESTIMATEDFINISH 	FROM WFSTRUCT STRUCT INNER JOIN WFSUBPROCESS SUB ON STRUCT.IDOBJECT = SUB.IDOBJECT INNER JOIN WFPROCESS WFPD ON WFPD.IDOBJECT = SUB.IDSUBPROCESS WHERE STRUCT.IDOBJECT = WFACTIVITY.IDOBJECT) = CAST(CURRENT_DATE AS TIMESTAMP) 
						--AND (	SELECT WFPD.NRTIMEESTFINISH 	FROM WFSTRUCT STRUCT INNER JOIN WFSUBPROCESS SUB ON STRUCT.IDOBJECT = SUB.IDOBJECT INNER JOIN WFPROCESS WFPD ON WFPD.IDOBJECT = SUB.IDSUBPROCESS WHERE STRUCT.IDOBJECT = WFACTIVITY.IDOBJECT) >= (EXTRACT(MINUTE FROM CURRENT_TIMESTAMP) + EXTRACT(HOUR FROM CURRENT_TIMESTAMP) * 60)) 
						--OR ((	SELECT WFPD.DTESTIMATEDFINISH 	FROM WFSTRUCT STRUCT INNER JOIN WFSUBPROCESS SUB ON STRUCT.IDOBJECT = SUB.IDOBJECT INNER JOIN WFPROCESS WFPD ON WFPD.IDOBJECT = SUB.IDSUBPROCESS WHERE STRUCT.IDOBJECT = WFACTIVITY.IDOBJECT) = CAST((CURRENT_DATE + INTERVAL '1 day') AS TIMESTAMP)) 
						--	THEN 'Próximo do vencimento' 
						--ELSE 'Em atraso' 
						--END 
						'Em dia'
					ELSE
						CASE WHEN 	(WFACTIVITY.DTESTIMATEDFINISH > CAST((CURRENT_DATE + INTERVAL '1 day') AS TIMESTAMP) OR WFACTIVITY.DTESTIMATEDFINISH IS NULL) 
							THEN 'Em dia' 
						WHEN 		(WFACTIVITY.DTESTIMATEDFINISH = CAST((CURRENT_DATE + INTERVAL '1 day') AS TIMESTAMP))
						OR 			(WFACTIVITY.DTESTIMATEDFINISH = CAST(CURRENT_DATE AS TIMESTAMP) AND WFACTIVITY.NRTIMEESTFINISH >= (EXTRACT(MINUTE FROM CURRENT_TIMESTAMP) + EXTRACT(HOUR FROM CURRENT_TIMESTAMP) * 60)) 
							THEN 'Próximo do vencimento' 
						ELSE 'Em atraso' 
						END 
					END 
				END AS ESTADOATV,
				CASE WFP.FGSLASTATUS 
					WHEN 10 THEN '#{218492}' 
					WHEN 30 THEN '#{218493}' 
					WHEN 40 THEN '#{218494}' 
				END AS IDSLASTATUS,
				WFACTIVITY.DTESTIMATEDFINISH + (WFACTIVITY.NRTIMEESTFINISH * interval '1 minute')  					AS PRAZO_ATV

		  FROM	DYNdevctc05 		TABLE0 		
	INNER JOIN	GNASSOCFORMREG 	FORMREG ON FORMREG.OIDENTITYREG = TABLE0.OID 
	INNER JOIN	WFPROCESS WFP ON FORMREG.CDASSOC = WFP.CDASSOCREG
	 LEFT JOIN	WFSTRUCT WFACTIVITY ON WFP.IDOBJECT = WFACTIVITY.IDPROCESS AND WFACTIVITY.FGTYPE IN(2,3) 
	 
	 LEFT JOIN	DYNdevctc05impleme 	REF0 ON TABLE0.OIDABCFOZ82IGOXLDK=REF0.OID 
	 LEFT JOIN	DYNdevctc05local 	REF1 ON TABLE0.OIDABC03WM7JRSW6HK=REF1.OID 
	 LEFT JOIN	DYNconctb01seg 		REF2 ON TABLE0.OIDABC88NP5F5CWOTW=REF2.OID 
	 LEFT JOIN	DYNdevctc05tipofab 	REF3 ON TABLE0.OIDABCEUNPYX4WNEV5=REF3.OID 
	 LEFT JOIN	DYNconctb01unid 	REF4 ON TABLE0.OIDABCQGQSQA0HEB0M=REF4.OID
	 LEFT JOIN	DYNdevctc05prodaca 	REF5 ON TABLE0.OID=REF5.OIDABCU9ATRDQ2HICV
	 LEFT JOIN	DYNdevctc05prodsem 	REF6 ON TABLE0.OID=REF6.OIDABC7YZRAWM760PP
	 LEFT JOIN	DYNdevctc05compone 	REF7 ON TABLE0.OID=REF7.OIDABCPZA0BQMILNI1
	 LEFT JOIN	DYNdevctc05estrutu 	REF8 ON TABLE0.OID=REF8.OIDABCUEAEXIK5149W   	
	 
	 LEFT JOIN	ADALLUSERS ADU ON ADU.CDUSER=WFP.CDUSERSTART
	 LEFT JOIN	GNREVISIONSTATUS GNRS ON WFP.CDSTATUS=GNRS.CDREVISIONSTATUS 
		 WHERE	WFP.IDPROCESSMODEL = 'DEV-CTC05' AND GNRS.IDREVISIONSTATUS <> 'ST-DEVCTC05-01' -- ANULADO			 	
) TEMPTB1